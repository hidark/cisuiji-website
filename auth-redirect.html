<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é‚®ç®±éªŒè¯æˆåŠŸ - è¯éšè®° WordSnap</title>
  <meta name="description" content="è¯éšè®°é‚®ç®±éªŒè¯æˆåŠŸé¡µé¢">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 24px;
      padding: 60px 40px;
      max-width: 520px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      text-align: center;
      animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(40px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .icon-wrapper {
      width: 100px;
      height: 100px;
      margin: 0 auto 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 0 0 20px rgba(102, 126, 234, 0);
      }
    }

    .icon {
      font-size: 48px;
      animation: bounce 1s ease-in-out;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    h1 {
      font-size: 32px;
      color: #1a202c;
      margin-bottom: 16px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .subtitle {
      font-size: 18px;
      color: #718096;
      margin-bottom: 40px;
      line-height: 1.6;
    }

    .button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 18px 48px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
      width: 100%;
      max-width: 300px;
      margin: 0 auto;
      display: block;
    }

    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 30px rgba(102, 126, 234, 0.6);
    }

    .button:active {
      transform: translateY(0);
    }

    .countdown {
      font-size: 16px;
      color: #667eea;
      margin-top: 24px;
      font-weight: 500;
      min-height: 24px;
    }

    .note {
      font-size: 14px;
      color: #a0aec0;
      margin-top: 32px;
      line-height: 1.6;
      padding: 20px;
      background: #f7fafc;
      border-radius: 12px;
    }

    .steps {
      text-align: left;
      margin-top: 24px;
      padding: 20px;
      background: #edf2f7;
      border-radius: 12px;
      display: none;
    }

    .steps h3 {
      font-size: 16px;
      color: #2d3748;
      margin-bottom: 12px;
    }

    .steps ol {
      margin-left: 20px;
      color: #4a5568;
      font-size: 14px;
      line-height: 1.8;
    }

    .error-message {
      background: #fff5f5;
      border: 1px solid #fc8181;
      color: #c53030;
      padding: 16px;
      border-radius: 12px;
      margin-top: 24px;
      display: none;
      font-size: 14px;
      line-height: 1.6;
    }

    .spinner {
      width: 40px;
      height: 40px;
      margin: 20px auto;
      border: 4px solid #e2e8f0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 480px) {
      .container {
        padding: 40px 24px;
      }

      h1 {
        font-size: 24px;
      }

      .subtitle {
        font-size: 16px;
      }

      .button {
        font-size: 16px;
        padding: 16px 32px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="icon-wrapper">
      <div class="icon">âœ…</div>
    </div>

    <h1 id="title">é‚®ç®±éªŒè¯æˆåŠŸï¼</h1>
    <p class="subtitle" id="subtitle">
      æ‚¨çš„é‚®ç®±å·²æˆåŠŸéªŒè¯ã€‚ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰“å¼€è¯éšè®°æ‰©å±•ç»§ç»­ä½¿ç”¨ã€‚
    </p>

    <button class="button" id="open-button" onclick="openExtension()">
      æ‰“å¼€è¯éšè®°æ‰©å±•
    </button>

    <div class="countdown" id="countdown">
      <span id="countdown-text">3 ç§’åè‡ªåŠ¨æ‰“å¼€...</span>
    </div>

    <div class="spinner" id="spinner"></div>

    <div class="error-message" id="error-message">
      âŒ æ— æ³•è‡ªåŠ¨æ‰“å¼€æ‰©å±•ã€‚è¯·æŒ‰ç…§ä¸‹æ–¹æ­¥éª¤æ‰‹åŠ¨æ“ä½œã€‚
    </div>

    <div class="note">
      <strong>ğŸ’¡ æç¤ºï¼š</strong>
      å¦‚æœæ²¡æœ‰è‡ªåŠ¨æ‰“å¼€ï¼Œè¯·ç¡®ä¿æ‚¨å·²å®‰è£…"è¯éšè®° WordSnap"æ‰©å±•ã€‚
    </div>

    <div class="steps" id="manual-steps">
      <h3>æ‰‹åŠ¨æ‰“å¼€æ‰©å±•ï¼š</h3>
      <ol>
        <li>ç‚¹å‡»æµè§ˆå™¨å·¥å…·æ å³ä¸Šè§’çš„æ‰©å±•å›¾æ ‡ï¼ˆæ‹¼å›¾å½¢çŠ¶ï¼‰</li>
        <li>æ‰¾åˆ°"è¯éšè®°-WordSnap"</li>
        <li>ç‚¹å‡»æ‰©å±•å›¾æ ‡æˆ–é€‰æ‹©"é€‰é¡¹"</li>
        <li>ä½¿ç”¨æ‚¨çš„è´¦å·ç™»å½•</li>
      </ol>
    </div>
  </div>

  <script>
    // ============================================================================
    // é…ç½®éƒ¨åˆ†
    // ============================================================================

    // âš ï¸ é‡è¦ï¼šè¿™ä¸ªæ‰©å±• ID éœ€è¦åœ¨ç”¨æˆ·å®‰è£…åæ‰èƒ½ç¡®å®š
    // å¯¹äºå·²å‘å¸ƒåˆ° Chrome Web Store çš„æ‰©å±•ï¼ŒID æ˜¯å›ºå®šçš„
    // å¯¹äºå¼€å‘æ¨¡å¼çš„æ‰©å±•ï¼Œæ¯æ¬¡åŠ è½½ ID å¯èƒ½ä¸åŒ

    // è¯éšè®°æ‰©å±•çš„ Chrome Web Store IDï¼ˆå¦‚æœå·²å‘å¸ƒï¼‰
    // æˆ–è€…æ‚¨çš„å¼€å‘ç¯å¢ƒæ‰©å±• ID
    const EXTENSION_ID = 'pambnljhfebdfjpemkgbacebcgdfallm'; // æ›¿æ¢ä¸ºå®é™… ID

    // æ„å»ºæ‰©å±• URL
    const EXTENSION_OPTIONS_URL = `chrome-extension://${EXTENSION_ID}/src/options/index.html`;

    // ============================================================================
    // æ ¸å¿ƒåŠŸèƒ½
    // ============================================================================

    let countdownValue = 3;
    let countdownTimer = null;
    let hasAttemptedOpen = false;

    /**
     * å°è¯•æ‰“å¼€æ‰©å±•
     */
    function openExtension() {
      const button = document.getElementById('open-button');
      const countdownEl = document.getElementById('countdown');
      const spinner = document.getElementById('spinner');
      const errorMessage = document.getElementById('error-message');
      const manualSteps = document.getElementById('manual-steps');

      // åœæ­¢å€’è®¡æ—¶
      if (countdownTimer) {
        clearInterval(countdownTimer);
      }

      // æ ‡è®°å·²å°è¯•æ‰“å¼€
      hasAttemptedOpen = true;

      // æ›´æ–° UI
      button.disabled = true;
      button.textContent = 'æ­£åœ¨æ‰“å¼€...';
      countdownEl.style.display = 'none';
      spinner.style.display = 'block';

      // å°è¯•è·³è½¬åˆ°æ‰©å±•
      console.log('Attempting to open extension:', EXTENSION_OPTIONS_URL);

      try {
        window.location.href = EXTENSION_OPTIONS_URL;
      } catch (error) {
        console.error('Failed to open extension:', error);
        showError();
        return;
      }

      // æ£€æµ‹æ˜¯å¦æˆåŠŸæ‰“å¼€
      // å¦‚æœ 3 ç§’åé¡µé¢ä»ç„¶æœ‰ç„¦ç‚¹ï¼Œè¯´æ˜æ²¡æœ‰æˆåŠŸè·³è½¬
      setTimeout(() => {
        if (document.hasFocus()) {
          console.log('Page still has focus - extension might not have opened');
          showError();
        }
      }, 3000);
    }

    /**
     * æ˜¾ç¤ºé”™è¯¯æç¤ºå’Œæ‰‹åŠ¨æ­¥éª¤
     */
    function showError() {
      const button = document.getElementById('open-button');
      const spinner = document.getElementById('spinner');
      const errorMessage = document.getElementById('error-message');
      const manualSteps = document.getElementById('manual-steps');

      button.disabled = false;
      button.textContent = 'é‡è¯•æ‰“å¼€æ‰©å±•';
      spinner.style.display = 'none';
      errorMessage.style.display = 'block';
      manualSteps.style.display = 'block';
    }

    /**
     * å¯åŠ¨å€’è®¡æ—¶
     */
    function startCountdown() {
      const countdownTextEl = document.getElementById('countdown-text');

      countdownTimer = setInterval(() => {
        countdownValue--;

        if (countdownValue > 0) {
          countdownTextEl.textContent = `${countdownValue} ç§’åè‡ªåŠ¨æ‰“å¼€...`;
        } else {
          clearInterval(countdownTimer);
          countdownTextEl.textContent = 'æ­£åœ¨æ‰“å¼€æ‰©å±•...';
          openExtension();
        }
      }, 1000);
    }

    /**
     * æ£€æŸ¥ URL å‚æ•°
     */
    function checkUrlParams() {
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token');
      const type = params.get('type');
      const error = params.get('error');
      const errorDescription = params.get('error_description');

      console.log('URL params:', { token, type, error, errorDescription });

      // å¦‚æœæœ‰é”™è¯¯å‚æ•°ï¼Œæ˜¾ç¤ºé”™è¯¯
      if (error) {
        const titleEl = document.getElementById('title');
        const subtitleEl = document.getElementById('subtitle');
        const errorMessage = document.getElementById('error-message');
        const countdown = document.getElementById('countdown');
        const button = document.getElementById('open-button');

        titleEl.textContent = 'éªŒè¯å¤±è´¥';
        subtitleEl.textContent = errorDescription || 'é‚®ç®±éªŒè¯é‡åˆ°é—®é¢˜ï¼Œè¯·é‡è¯•ã€‚';
        errorMessage.style.display = 'block';
        errorMessage.textContent = `âŒ ${errorDescription || error}`;
        countdown.style.display = 'none';
        button.textContent = 'è¿”å›æ‰©å±•';

        return false;
      }

      return true;
    }

    /**
     * æ£€æµ‹æ‰©å±•æ˜¯å¦å·²å®‰è£…
     */
    function detectExtension() {
      // å°è¯•åˆ›å»ºä¸€ä¸ªæŒ‡å‘æ‰©å±•èµ„æºçš„ img å…ƒç´ 
      // å¦‚æœæ‰©å±•å·²å®‰è£…ï¼Œèµ„æºå¯ä»¥åŠ è½½
      // æ³¨æ„ï¼šè¿™éœ€è¦æ‰©å±•åœ¨ manifest ä¸­é…ç½® web_accessible_resources

      return new Promise((resolve) => {
        const img = new Image();
        const timeout = setTimeout(() => {
          resolve(false);
        }, 2000);

        img.onload = () => {
          clearTimeout(timeout);
          resolve(true);
        };

        img.onerror = () => {
          clearTimeout(timeout);
          resolve(false);
        };

        // å°è¯•åŠ è½½æ‰©å±•çš„å›¾æ ‡
        img.src = `chrome-extension://${EXTENSION_ID}/src/assets/icon16.png`;
      });
    }

    /**
     * åˆå§‹åŒ–
     */
    async function init() {
      // æ£€æŸ¥ URL å‚æ•°
      const isValid = checkUrlParams();
      if (!isValid) {
        return;
      }

      // æ£€æµ‹æ‰©å±•æ˜¯å¦å·²å®‰è£…
      const extensionInstalled = await detectExtension();
      console.log('Extension installed:', extensionInstalled);

      if (!extensionInstalled) {
        // æ‰©å±•æœªå®‰è£…ï¼Œæ˜¾ç¤ºæç¤º
        const subtitle = document.getElementById('subtitle');
        const button = document.getElementById('open-button');
        const countdown = document.getElementById('countdown');
        const note = document.querySelector('.note');

        subtitle.innerHTML = 'è¯·å…ˆå®‰è£…"è¯éšè®° WordSnap"æ‰©å±•ã€‚<br>å®‰è£…ååˆ·æ–°æ­¤é¡µé¢ã€‚';
        button.textContent = 'å‰å¾€ Chrome åº”ç”¨å•†åº—';
        button.onclick = () => {
          // æ›¿æ¢ä¸ºå®é™…çš„ Chrome Web Store é“¾æ¥
          window.open('https://chrome.google.com/webstore/detail/wordsnap/YOUR_STORE_ID', '_blank');
        };
        countdown.style.display = 'none';
        note.innerHTML = '<strong>âš ï¸ æ³¨æ„ï¼š</strong>æ‚¨éœ€è¦å…ˆå®‰è£…æ‰©å±•æ‰èƒ½ç»§ç»­ã€‚';

        return;
      }

      // å¯åŠ¨è‡ªåŠ¨è·³è½¬å€’è®¡æ—¶
      startCountdown();
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && hasAttemptedOpen) {
        // é¡µé¢å¤±å»ç„¦ç‚¹ï¼Œå¯èƒ½æ˜¯æˆåŠŸæ‰“å¼€äº†æ‰©å±•
        console.log('Page lost focus - extension likely opened successfully');
      }
    });

    // é˜²æ­¢é¡µé¢åé€€
    window.history.pushState(null, '', window.location.href);
    window.onpopstate = () => {
      window.history.pushState(null, '', window.location.href);
    };
  </script>
</body>
</html>
