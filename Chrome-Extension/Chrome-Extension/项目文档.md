## 项目文档（Architecture & Implementation）— 词随记

### 技术栈与运行时
- **Chrome MV3**: `manifest.json`、Service Worker（后台）、Content Script、Popup、Options。
- **存储**: `chrome.storage.local`（v1.0），后续可选 `storage.sync`。
- **网络**: `fetch` + 超时/重试；词典源优先 `dictionaryapi.dev`（可配置）。
- **构建**: 建议 Vite/Rollup/Webpack 任一；输出到 `dist/`。

### 模块划分
- **background**: 上下文菜单、请求队列、通知/闹钟、词典拉取、存储写入。
- **content-script**: 读取选区/语言、采集页面标题与 URL、与后台通信。
- **popup**: 列表与复习 UI；操作（掌握/模糊/错误/删除/学会）。
- **options**: 设置项（数据源、强度、每日、时间窗）、导入/导出、清空、统计。
- **core**: 数据模型、SRS 计算、去重与合并、CSV/JSON 转换、API 客户端、缓存与退避。

### 关键流程
- **加词流程**
  1) Content Script 读取选中词与页面信息；
  2) 发送消息至 Background；
  3) Background 立即写入条目（pending 释义）；
  4) 拉取在线词典（超时 3s，失败回退本地词库）；
  5) 更新释义并通知 Popup 刷新。
- **通知流程**
  1) `alarms` 定期唤醒并查询 `dueAt`；
  2) 位于 `notifyWindow` 时间段内则推送通知；
  3) 点击通知打开 Popup 并定位到首个待复习。
- **复习流程**
  1) Popup 展示待复习卡片/列表；
  2) 用户打分；
  3) Core 计算 SRS 并更新存储；
  4) UI 跳转下一词，统计更新。

### 接口契约（消息与数据）
- **AddWordMessage**: `{ text: string, pageTitle: string, url: string, language?: string }`
- **Definition**: `{ definition: string, partOfSpeech: string[], source: 'online' | 'local' }`
- **Persisted Keys**:
  - `wordsById`: `Record<WordEntry.id, WordEntry>`
  - `settings`: `Settings`
  - `stats`: `{ todayCompleted: number, streakDays: number, lastOpenedAt: number }`

### 数据结构（复用 PRD 定义）
- 见 `需求文档.md` 的 WordEntry 与 Settings。实现时在 `core/models` 定义 TypeScript 接口以约束。

### 目录结构（建议）
```text
Chrome-Extension/
  manifest.json
  src/
    background/
    content/
    popup/
    options/
    core/              # models, srs, storage, api, util
    assets/            # icons, local-dict.json
  test/
    unit/
    e2e/
  scripts/            # build, pack
  dist/
```

### 构建与工具链
- **Lint/Format**: ESLint + Prettier；提交前校验。
- **测试**: Vitest/Jest 单测；Puppeteer/ChromeDriver E2E。
- **版本与日志**: SemVer，维护 `CHANGELOG.md`；仅本地轻量日志（无远端上报）。

### 配置与权限
- **权限**: `contextMenus`, `storage`, `notifications`, `alarms`, `activeTab`；可选 `scripting`, `tabs`。
- **主机权限**: 词典 API 域名白名单（可在 Options 配置）。

### 发布与上架流程
- 本地打包 `dist/` → 开发者模式加载自测 → 打包 zip 上传 Chrome Web Store → 填写隐私说明和权限用途 → 提交审核 → 通过后发布。

### 指标与可观测性
- **本地指标**: 加词数、复习完成数、错误计数。
- **诊断导出**: 允许导出本地日志以便问题排查。


